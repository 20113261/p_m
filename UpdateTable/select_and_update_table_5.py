#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Time    : 2017/12/6 下午9:34
# @Author  : Hou Rong
# @Site    : 
# @File    : select_and_update_table.py
# @Software: PyCharm
import re
import json
from data_source import MysqlSource
from service_platform_conn_pool import poi_ori_pool, poi_face_detect_pool, service_platform_pool, base_data_final_pool, \
    fetchall
from logger import get_logger

logger = get_logger("select_and_update_table")

poi_ori_config = {
    'host': '10.10.228.253',
    'user': 'mioji_admin',
    'password': 'mioji1109',
    'charset': 'utf8',
    'db': 'poi_merge'
}


def update_sql(data):
    sql = '''UPDATE chat_attraction
SET beentocount = %s, plantocount = %s, commentcount = %s
WHERE id = %s;'''
    conn = poi_ori_pool.connection()
    cursor = conn.cursor()
    try:
        _res = cursor.execute(sql, data)
    except Exception:
        print(sql)
        raise Exception()
    conn.commit()
    cursor.close()
    conn.close()
    logger.info("[total: {}][execute: {}]".format(1, _res))


def generate_qyer_url_id():
    sql = '''SELECT
  url,
  commentcounts,
  beentocounts,
  plantocounts
FROM detail_total_qyer_20171209a;'''
    _dict = {}
    for url, bc, cc, pc in fetchall(service_platform_pool, sql):
        sid = re.findall('place.qyer.com/poi/([\s\S]+)/', url)[-1]
        _dict[sid] = (bc, cc, pc)
    return _dict


def get_task():
    g_dict = generate_qyer_url_id()
    sql = '''SELECT
  id,
  commentcount,
  beentocount,
  plantocount,
  json_extract(url, '$.qyer')
FROM chat_attraction
WHERE id IN
      ('v200847','v201724','v201727','v201873','v651829','v647292','v217766','v655028','v701518','v223865','v227401','v228923','v230688','v231351','v231704','v232645','v233491','v234243','v234944','v235709','v235711','v238707','v239881','v239973','v240117','v240120','v241206','v242508','v242843','v242908','v243532','v244241','v244842','v245265','v247648','v247936','v248013','v723419','v266280','v266284','v266291','v266292','v266293','v266295','v273436','v274181','v274192','v290457','v310408','v310411','v310413','v310414','v311222','v311231','v311246','v311285','v734510','v647212','v514453','v514454','v514455','v514456','v514807','v515408','v515598','v515599','v516378','v516994','v516998','v518134','v518188','v518189','v518190','v518191','v518192','v518193','v518195','v518244','v518245','v518246','v518247','v518248','v518249','v518256','v518259','v518260','v518264','v518267','v701848','v701849','v701850','v701859','v701853','v701504','v569633','v569642','v569667','v569671','v569696','v569714','v569722','v569723','v569740','v569742','v569748','v569783','v569793','v569794','v569804','v569805','v569816','v569836','v701583','v649832','v711604','v701460','v701578','v701581','v701620','v701570','v587037','v587073','v701425','v701457','v705626','v701440','v701497','v617191','v701449','v710291','v706859','v707536','v701450','v686007','v638484','v638490','v638496','v518251','v516381','v518261','v517040','v518194','v701845','v514998','v741192','v724474','v274204','v516996','v516283','v701615','v701623','v518252','v310253','v516992','v515597','v518250','v310415','v310412','v310407','v310409','v518258','v516379','v518263','v516997','v516380','v515421','v516995','v513765','v513853','v518257','v516993','v518253','v518254','v516991','v518527','v515423','v516047','v515418','v516656','v515422','v641415','v642217','v736452','v648210','v655023','v643047','v657849','v658811','v652553','v652589','v652597','v652614','v643847','v657141','v644629','v646646','v664857','v664858','v646881','v663826','v663827','v651417','v651504','v674038','v674040','v670512','v673731','v673732','v673733','v673734','v674986','v649945','v652007','v675636','v675637','v650188','v650191','v650193','v683279','v680623','v680624','v680626','v699845','v699852','v699853','v699854','v699855','v701846','v701847','v701851','v701852','v701854','v701855','v701856','v701860','v689280','v701542','v701543','v701548','v701557','v701558','v701559','v701560','v701561','v701562','v701563','v701564','v701565','v701566','v701567','v701568','v701569','v701571','v701572','v701573','v701574','v701575','v701576','v701577','v701579','v701580','v701582','v701584','v701585','v701586','v701587','v701588','v701589','v701590','v701591','v701592','v701593','v701594','v701595','v701596','v701597','v701598','v701599','v701600','v701601','v701602','v701603','v701604','v701605','v701606','v701607','v701608','v701609','v701610','v701611','v701612','v701613','v701614','v701616','v701617','v701618','v701619','v701621','v701622','v701624','v701625','v701626','v701627','v701628','v701629','v701630','v701661','v701664','v701251','v703536','v706671','v707806','v707537','v712272','v711605','v711607','v719913','v719914','v719916','v719925','v723357','v723358','v723359','v723360','v723361','v723418','v723420','v723421','v723422','v723423','v724473','v720296','v721497','v721498','v737402','v736451','v703914','v699408','v705627','v705628','v701409','v701410','v701411','v701413','v701414','v701417','v701418','v701419','v701420','v741169','v701421','v701422','v701423','v701424','v701426','v701427','v701428','v701429','v710284','v701430','v710285','v701431','v701432','v701433','v701434','v710286','v710287','v701435','v701436','v701437','v701438','v701439','v710288','v741114','v701441','v701442','v710289','v701443','v701444','v701445','v701446','v701447','v741117','v701448','v701451','v701452','v701453','v701454','v741112','v701455','v701456','v701458','v701459','v701461','v701462','v701463','v701464','v701465','v701466','v701467','v701468','v701469','v701470','v740990','v740991','v701471','v741089','v701472','v701473','v701474','v701475','v701476','v701477','v701478','v701479','v701480','v701481','v701482','v701483','v701484','v701485','v701486','v701487','v701488','v701489','v701490','v701491','v701492','v741056','v701493','v701494','v701495','v701496','v741044','v701498','v701499','v701500','v741045','v701501','v741043','v701502','v701503','v701505','v741040','v701506','v701507','v701508','v701509','v701510','v701511','v701512','v701513','v701514','v701515','v701516','v701517','v701519','v701520','v701521','v701522','v701523','v701524','v701525','v740992','v741003','v739520','v739524','v739525','v739526','v739527','v739528','v739529','v739530','v739531','v739532','v740973');'''
    data = []
    _count = 0
    _err_count = 0
    for uid, b_c, p_c, c_c, q_url in MysqlSource(poi_ori_config, table_or_query=sql,
                                                 size=10000, is_table=False,
                                                 is_dict_cursor=False):
        _count += 1
        if not str(q_url).endswith('/'):
            q_url += '/'
        q_url_id = re.findall('http://place.qyer.com/poi/(\S+?)/', q_url)[-1]

        bc_d = json.loads(b_c)
        # if 'qyer' in bc_d:
        #     del bc_d['qyer']
        pc_d = json.loads(p_c)
        # if 'qyer' in pc_d:
        #     del pc_d['qyer']
        cc_d = json.loads(c_c)
        # del cc_d['qyer']

        res = g_dict.get(q_url_id)
        if res:
            bc, cc, pc = res
            bc_d['qyer'] = int(bc)
            cc_d['qyer'] = int(cc)
            pc_d['qyer'] = int(pc)
            print(uid, json.dumps(bc_d), json.dumps(pc_d), json.dumps(cc_d), q_url_id, q_url)
        else:
            _err_count += 1
            print()
            print('##' * 10)
            print(uid, json.dumps(bc_d), json.dumps(pc_d), json.dumps(cc_d), q_url_id, q_url)
            print('##' * 10)
            print()

        logger.info("[count: {}]".format(_count))
        logger.info("[err_count: {}]".format(_err_count))
        update_sql((json.dumps(bc_d), json.dumps(pc_d), json.dumps(cc_d), uid))
        # if len(data) == 1000:
        #     logger.info("[count: {}]".format(_count))
        #         update_sql(data)
        #         data = []
        # update_sql(data)


if __name__ == '__main__':
    get_task()
