<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>生成景点酒店配置文件</title>
    <style type="text/css">
        body{
            background-color: #ccc;
        }
    </style>
    <!--<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>-->
    <!--<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>-->
</head>
<body>
    <div class="wrap">
		<button id="up">点击上传文件</button>
		<div>
			<p id="before"></p>
			<p id="process"></p>
            <p id="taskprocess"></p>
            <p id="configfiles"></p>
            <div id="generatedfiles">
                <a id="sign"></a>
                <a id="hotel"></a>
            </div>
		</div>
	</div>
    <script type="text/javascript">
        var btn = document.getElementById('up'),
		bf = document.getElementById("before"),
		prs = document.getElementById("process"),
        task_prs = document.getElementById("taskprocess"),
        option = {
            url: '/upload',
            process_url: '/taskprocess',
            maxSize: 100,
            multiple: true,
            beforeSend: function(file){
                bf.innerText = "开始上传...";
            },
            callback: function(res){
                res = JSON.parse(res);
                if(res && res.code == 0){
                    // alert("上传成功！");
                    bf.innerText = "上传成功!";
                    get_task_process(option);
                }else{
                    alert(res.msg);
                }
            },
            callback_process: function(res){
                res = JSON.parse(res);
                if(res && res.code == 0){
                    var pre = res.process;
                    task_prs.innerText = "任务进度为: "+ pre;
                    if(pre!="100%"){
                        get_task_process(option);
                    }else{
                        console.log("文件生成完成");
                        showconfigfiles();
                    }
                }else{
                    alert(res.msg);
                }
            },
            uploading: function(pre){
                prs.innerText = "当前上传进度为：" + pre + "%";
            }
        }


        btn.onclick = function(){
            myUpload(option);
        }

        function myUpload(option){
            var fd = new FormData(),
            xhr = new XMLHttpRequest(),
            input = document.createElement('input');

            input.setAttribute('id', 'myUploadInput');
            input.setAttribute('type', 'file');
            input.setAttribute('name', 'file');
            if(option.multiple){
                input.setAttribute('multiple', true);
            }
            document.body.appendChild(input);
            input.style.display = 'none';
            input.click();
            var fileType = ['csv', 'zip'];
            input.onchange = function(){
                if(!input.value){return;}
                console.log(input.value);
                var type = input.value.split('.').pop();
                if(fileType.indexOf(type.toLocaleLowerCase()) == -1){
                    alert("暂不支持该类型的文件，请重新选择!");
                    return;
                }
                for(var i=0, file; file=input.files[i++];){
                    if(option.maxSize &&  file.size > option.maxSize * 1024 * 1024){
                        alert('请上传小于'+option.maxSize+'M的文件');
                        return;
                    }
                }
                if(option.beforeSend instanceof Function){
                    if(option.beforeSend(input) === false){
                        return false;
                    }
                }
                for(var i=0, file; file=input.files[i++];){
                    console.log(fd)
                    fd.append('myfile', file);
                    fd.append('param', '688');
                }
                xhr.open('post', option.url);
                xhr.onreadystatechange = function(){
                    if(xhr.status == 200){
                        if(xhr.readyState == 4){
                            if(option.callback instanceof Function){
                                option.callback(xhr.responseText);
                            }
                        }
                    }else{
                        alert("上传失败！");
                    }
                }
                xhr.upload.onprogress = function(event){
                    var pre = Math.floor(100 * event.loaded / event.total);
                    if(option.uploading instanceof Function){
                        option.uploading(pre);
                    }
                }
                xhr.send(fd);
            }
        }

        var get_task_process = function(option){
            setTimeout(function(){
                var xhr = new XMLHttpRequest();
                xhr.open('get', option.process_url, true);
                xhr.onreadystatechange = function(){
                    if(xhr.status == 200){
                        if(xhr.readyState == 4){
                            if(option.callback instanceof Function){
                                option.callback_process(xhr.responseText);
                            }
                        }
                    }else{
                        alert("获取进度失败！");
                    }
                }
                xhr.send();
            }, 1000)
        }

        var showconfigfiles = function(){
            var configfiles = document.getElementById('configfiles'),
                generatedfiles = document.getElementById('generatedfiles'),
                sign = document.getElementById('sign'),
                hotel = document.getElementById('hotel');
            configfiles.innerHTML = "配置文件已生成: ";
            sign.innerHTML = "景点配置";
            sign.href = "/download/sign";
            hotel.innerHTML = "酒店配置";
            hotel.href = "/download/hotel";
        }

    </script>
</body>
</html>